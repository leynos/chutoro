# Debugging Plan: Hanging edge_harvest property tests

**Generated**: 2026-01-05T19:25:46Z
**Issue ID**: N/A
**Severity**: High (tests hang >2h)

## Problem Statement

Several `edge_harvest_*` property tests hang for long periods (reported >2h),
blocking CI and local validation. Expected behaviour is completion within the
normal test window (seconds or minutes). The issue appears in specific rstest
cases for determinism and validity.

## Context Summary

| Aspect              | Details                                  |
| ------------------- | ---------------------------------------- |
| First observed      | Unknown                                  |
| Reproduction rate   | Consistent for listed cases              |
| Affected components | chutoro-core edge harvest property tests |
| Recent changes      | Unknown                                  |

### Error Artefacts

```text
Test run active >2h. The following cases each ran >60s:
- edge_harvest_determinism_rstest_cases::case_4
- edge_harvest_validity_rstest_cases::case_3
- edge_harvest_validity_rstest_cases::case_4
- edge_harvest_validity_rstest_cases::case_5
```

### Information Gaps

- Exact command used to run tests (nextest vs cargo test).
- Recent commits or diffs touching edge harvest logic.
- Runtime environment details (CPU count, memory, RUSTFLAGS).
- Whether hangs reproduce with single-threaded execution.

______________________________________________________________________

## Hypotheses

### H1: Fixtures generate extreme graph sizes (O(n^2)/O(n^3))

**Claim**: The affected cases build graphs large enough that edge harvesting
(de-dup, sorting, or reconciliation) becomes effectively unbounded, so tests
appear to hang rather than fail.

**Plausibility**: High — multiple cases hang in the edge-harvest suite, and
performance scaling is a common failure mode for property fixtures.

**Prediction**: Instrumentation will show very large fixture sizes or neighbour
list sizes, and runtime will scale super-linearly with fixture size.

#### Falsification Plan (H1)

| Step | Action                                                      | Expected Negative Result                                  |
| ---- | ----------------------------------------------------------- | --------------------------------------------------------- |
| 1    | Run a failing case with `--nocapture` and log fixture size. | The case still hangs with normal sizes and no huge lists. |
| 2    | Temporarily cap fixture sizes in rstest params and re-run.  | Runtime remains unbounded even with small caps.           |

**Tooling**:

```text
cargo test -p chutoro-core edge_harvest_validity_rstest_cases::case_3 \
  -- --nocapture --test-threads=1

cargo nextest run -p chutoro-core \
  -E 'test(edge_harvest_validity_rstest_cases::case_3)' --no-capture
```

**Confidence on falsification**: High.

______________________________________________________________________

### H2: Infinite or non-converging loop in trimming or reconciliation

**Claim**: A loop in edge harvesting or trimming relies on progress that does
not occur for certain graphs, leading to a near-infinite loop.

**Plausibility**: Medium — hangs are case-specific and could be triggered by
particular neighbour configurations or ordering constraints.

**Prediction**: A progress counter or iteration cap will reveal a loop that
runs without changing state.

#### Falsification Plan (H2)

| Step | Action                                                           | Expected Negative Result                         |
| ---- | ---------------------------------------------------------------- | ------------------------------------------------ |
| 1    | Add a debug counter in suspected loops and log iteration growth. | Iteration count stays low and loop terminates.   |
| 2    | Add an assert on progress each iteration and re-run.             | Assert never fires; loop progresses as expected. |

**Tooling**: Instrument
`chutoro-core/src/hnsw/tests/property/edge_harvest_property.rs` and
edge-harvest logic; single-case runs with `--nocapture`.

**Confidence on falsification**: Medium.

______________________________________________________________________

### H3: Concurrency interaction causes deadlock or starvation

**Claim**: A shared global (cache, RNG, tracing subscriber) is contended or
starves under parallel test execution; serial execution avoids the hang.

**Plausibility**: Medium — property tests often run in parallel by default.

**Prediction**: Running the same case with `RUST_TEST_THREADS=1` (or nextest
`--test-threads 1`) will complete quickly if deadlock is the issue.

#### Falsification Plan (H3)

| Step | Action                                           | Expected Negative Result                              |
| ---- | ------------------------------------------------ | ----------------------------------------------------- |
| 1    | Re-run a single case with `RUST_TEST_THREADS=1`. | The test still hangs under single-threaded execution. |

**Tooling**:

```text
RUST_TEST_THREADS=1 cargo test -p chutoro-core \
  edge_harvest_determinism_rstest_cases::case_4 -- --nocapture
```

**Confidence on falsification**: High.

______________________________________________________________________

### H4: Random seed yields pathological graphs

**Claim**: The random seed for these cases generates graphs with pathological
structures that trigger worst-case runtime.

**Plausibility**: Medium — the hang is case-specific and could be seed-driven.

**Prediction**: Forcing a different seed reduces runtime.

#### Falsification Plan (H4)

| Step | Action                                     | Expected Negative Result                 |
| ---- | ------------------------------------------ | ---------------------------------------- |
| 1    | Override the RNG seed and rerun the cases. | Runtime does not improve; hang persists. |

**Tooling**: Adjust seeds in rstest fixtures or use a deterministic RNG in
edge-harvest property tests.

**Confidence on falsification**: Medium.

______________________________________________________________________

### H5: Excessive retries or shrinking in test harness

**Claim**: The harness retries or shrinks excessively due to strict assertions,
causing long runtimes in specific cases.

**Plausibility**: Low–Medium — these are rstest cases, but they call proptest
helpers in other parts of the suite.

**Prediction**: Limiting shrink iterations or decreasing cases makes the tests
complete quickly.

#### Falsification Plan (H5)

| Step | Action                                                | Expected Negative Result                        |
| ---- | ----------------------------------------------------- | ----------------------------------------------- |
| 1    | Run with `PROPTEST_CASES=1` or cap shrink iterations. | Runtime remains high even with low case counts. |

**Tooling**: Env vars `PROPTEST_CASES`, `PROPTEST_MAX_SHRINK_ITERS` (if used).

**Confidence on falsification**: Low–Medium.

______________________________________________________________________

## Recommended Execution Order

1. **H3** — Fastest, cheapest (single-threaded run).
2. **H1** — Log fixture sizes to confirm or deny scaling issues.
3. **H2** — Instrument suspected loops if H1 and H3 do not explain the hang.
4. **H4** — Try fixed seed to rule out pathological RNG outcomes.
5. **H5** — Only if proptest is involved in these rstest cases.

## Termination Criteria

- **Root cause identified**: One hypothesis survives falsification and explains
  the hang with reproducible evidence.
- **Escalation trigger**: All hypotheses falsified; revisit recent changes or
  request additional logs or traces from CI.

## Notes for Executing Agent

- Focus on `chutoro-core/src/hnsw/tests/property/edge_harvest_property.rs` and
  edge harvest logic in `chutoro-core/src/hnsw/*`.
- Start with a single failing case to reduce noise.
- Record fixture sizes and iteration counts to correlate with runtime.
