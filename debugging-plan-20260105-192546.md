# Debugging Plan: Hanging edge_harvest property tests

**Generated**: 2026-01-05T19:25:46Z  
**Issue ID**: N/A  
**Severity**: High (tests hang >2h)

## Problem Statement

Several `edge_harvest_*` property tests hang for long periods (reported >2h),
blocking CI and local validation. Expected behaviour is completion within the
normal test window (typically seconds/minutes). The issue appears in specific
rstest cases for determinism/validity.

## Context Summary

| Aspect | Details |
|--------|---------|
| First observed | Unknown (not provided) |
| Reproduction rate | Appears consistent for listed cases |
| Affected components | `chutoro-core` HNSW edge harvest property tests |
| Recent changes | Unknown (not provided) |

### Error Artefacts

```
Test run active >2h. The following cases each ran >60s:
- edge_harvest_determinism_rstest_cases::case_4
- edge_harvest_validity_rstest_cases::case_3
- edge_harvest_validity_rstest_cases::case_4
- edge_harvest_validity_rstest_cases::case_5
```

### Information Gaps

- Exact command used to run tests (nextest vs cargo test).
- Any recent commits or diffs touching edge harvest logic.
- Runtime environment details (CPU count, memory, RUSTFLAGS).
- Whether hangs reproduce with single-threaded execution.

---

## Hypotheses

### H1: Specific rstest fixtures generate extreme graph sizes causing 
O(n^2)/O(n^3) behaviour

**Claim**: The affected cases build graphs large enough that edge harvesting
(de-dup, sorting, or reconciliation) is effectively unbounded for the current
algorithm, so tests appear to hang rather than fail.

**Plausibility**: High — multiple cases hang, all in edge-harvest property
suite; performance scaling is a common failure mode for property fixtures.

**Prediction**: If this is true, instrumentation will show very large fixture
sizes or neighbour list sizes, and runtime will scale super-linearly with
fixture size.

#### Falsification Plan

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Run a single failing case with `--nocapture` and log fixture size (e.g., log node count / edge count in the test). | The case still hangs with small/normal sizes (e.g., <= 200 nodes) and no unusually large lists. |
| 2 | Temporarily cap fixture sizes in rstest params (e.g., reduce ranges in case_3/4/5) and re-run. | Runtime remains unbounded even with small caps. |

**Tooling**: `cargo test -p chutoro-core edge_harvest_validity_rstest_cases::case_3 -- --nocapture --test-threads=1` (or `cargo nextest run -p chutoro-core -E 'test(edge_harvest_validity_rstest_cases::case_3)' --no-capture`), temporary logging.

**Confidence on falsification**: High — size/time correlation should be clear.

---

### H2: Infinite or non-converging loop in edge-harvest trimming/reconciliation

**Claim**: A loop in edge harvesting or trimming relies on progress that does
not occur for certain graphs, leading to an infinite/near-infinite loop.

**Plausibility**: Medium — hangs are case-specific and could be triggered by
particular neighbour configurations or ordering constraints.

**Prediction**: Adding a progress counter or iteration cap will reveal a loop
that runs without changing state.

#### Falsification Plan

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Add a debug counter in the suspected loop(s) (edge harvest, trimming, reconciliation) and log iteration count growth for case_4. | Iteration count stays low and loop terminates; no unbounded growth. |
| 2 | Add an assert on "progress made" each iteration and re-run the case. | Assert never fires; loop progresses as expected. |

**Tooling**: Instrumentation in `chutoro-core/src/hnsw/tests/property/edge_harvest_property.rs` and edge-harvest logic; single-case runs with `--nocapture`.

**Confidence on falsification**: Medium.

---

### H3: Concurrency interaction causes a deadlock or starvation when tests run 
with multiple threads

**Claim**: A shared global (e.g., cache, RNG, tracing subscriber) is contended
or deadlocks under parallel test execution; serial execution avoids the hang.

**Plausibility**: Medium — property tests often run in parallel by default.

**Prediction**: Running the same case with `RUST_TEST_THREADS=1` (or nextest
`--test-threads 1`) will complete quickly if deadlock is the issue.

#### Falsification Plan

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Re-run a single case with `RUST_TEST_THREADS=1` / `--test-threads=1`. | The test still hangs under single-threaded execution. |

**Tooling**: `RUST_TEST_THREADS=1 cargo test -p chutoro-core edge_harvest_determinism_rstest_cases::case_4 -- --nocapture`.

**Confidence on falsification**: High.

---

### H4: Random seed or fixture generation creates pathological graphs

**Claim**: The random seed for these cases generates graphs with pathological
structures (e.g., extreme degree distribution) that trigger worst-case runtime.

**Plausibility**: Medium — the hang is case-specific and could be seed-driven.

**Prediction**: Forcing a different seed or fixed RNG reduces runtime.

#### Falsification Plan

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Override the RNG seed (or replace random fixture with a fixed seed) and rerun the cases. | Runtime does not improve; hang persists. |

**Tooling**: Adjust seeds in the rstest fixtures or use a deterministic RNG in
edge-harvest property tests.

**Confidence on falsification**: Medium.

---

### H5: Test-level expectations are overly strict, causing repeated retries or
excessive property-case exploration

**Claim**: The test harness retries/shrinks excessively due to stringent
assertions, causing long runtimes in specific cases.

**Plausibility**: Low–Medium — these are rstest cases, but if they wrap proptest
helpers internally, shrinks could be excessive.

**Prediction**: Limiting shrink iterations or decreasing proptest cases will
make the tests complete quickly.

#### Falsification Plan

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Run with `PROPTEST_CASES=1` or cap shrink iterations if proptest is used under the hood. | Runtime remains high even with low case counts. |

**Tooling**: Env vars `PROPTEST_CASES`, `PROPTEST_MAX_SHRINK_ITERS` (if used).

**Confidence on falsification**: Low–Medium.

---

## Recommended Execution Order

1. **H3** — Fastest, cheapest (single-threaded run).
2. **H1** — Log fixture sizes to confirm/deny scaling issue.
3. **H2** — Instrument suspected loops if H1/H3 do not explain the hang.
4. **H4** — Try fixed seed to rule out pathological RNG outcomes.
5. **H5** — Only if proptest is involved in these rstest cases.

## Termination Criteria

- **Root cause identified**: One hypothesis survives falsification and explains
  the hang with reproducible evidence.
- **Escalation trigger**: All hypotheses falsified; revisit recent changes or
  request additional logs/trace from CI.

## Notes for Executing Agent

- Focus on `chutoro-core/src/hnsw/tests/property/edge_harvest_property.rs` and
  edge harvest logic in `chutoro-core/src/hnsw/*`.
- Start with a single failing case to reduce noise.
- Record fixture sizes and iteration counts to correlate with runtime.
