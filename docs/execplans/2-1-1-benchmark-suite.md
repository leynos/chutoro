# ExecPlan: create chutoro-benches with Criterion harness

This ExecPlan is a living document. The sections `Constraints`, `Tolerances`,
`Risks`, `Progress`, `Surprises & Discoveries`, `Decision Log`, and
`Outcomes & Retrospective` must be kept up to date as work proceeds.

**Status**: COMPLETE **Issue**: roadmap §2.1.1 **Branch**:
`add-chutoro-benchmarks-ldtc9r`

This document must be maintained in accordance with the project's ExecPlan
conventions established by prior plans in `docs/execplans/`.

## Purpose / big picture

After this change a developer can run `make bench` from the repository root and
see Criterion timing reports for the four CPU pipeline stages: Hierarchical
Navigable Small World (HNSW) index construction, edge harvest, minimum spanning
tree (MST), and hierarchy extraction. The benchmarks exercise realistic
synthetic workloads at multiple dataset sizes, providing a baseline for future
performance work. This is roadmap item 2.1.1, a prerequisite for the remaining
benchmarking and profiling tasks in §2.

Observable outcome: `make bench` completes and writes HTML reports to
`target/criterion/`. Each of the four benchmark groups produces timing data.
All quality gates (`make check-fmt`, `make lint`, `make test`) continue to
pass, including new unit tests for the benchmark support code.

## Constraints

- Maximum 400 lines per file (`AGENTS.md`).
- en-GB-oxendict spelling in comments and documentation.
- Caret version requirements for all new dependencies.
- `clippy.toml` thresholds: cognitive-complexity 9,
  too-many-arguments 4, too-many-lines 70, nesting 4.
- `.cargo/config.toml` enforces `-Dmissing_docs` and
  `-Dmissing_crate_level_docs` globally.
- Workspace Clippy lints deny `unwrap_used`, `expect_used`,
  `indexing_slicing`, `float_arithmetic`, `print_stdout`, `print_stderr`, and
  many others (see root `Cargo.toml`).
- The `chutoro-core` public API must not change.
- Existing tests must continue to pass unchanged.

## Tolerances (exception triggers)

- Scope: if implementation requires changes to more than 15 files or
  600 lines of new code (net), stop and escalate.
- Interface: if a `chutoro-core` public API signature must change, stop
  and escalate.
- Dependencies: the only new external dependencies permitted are
  `criterion` (benchmark harness) and `rand` (data generation). If others are
  required, stop and escalate.
- Iterations: if `make lint` or `make test` still fail after 3 fix
  attempts, stop and escalate.
- Ambiguity: if the benchmark design requires architectural choices not
  covered here, stop and present options.

## Risks

- Risk: Criterion's generated `main` function or macros may trigger
  workspace-level Clippy denials (e.g., `missing_docs`, `unwrap_used`).
  Severity: medium. Likelihood: high. Mitigation: the `chutoro-benches` crate
  will define its own `[lints]` section rather than inheriting from the
  workspace, allowing targeted relaxation for benchmark harness code while
  keeping library code strict. Benchmark source files (`benches/*.rs`) will use
  tightly scoped `#[expect]` attributes with reasons.

- Risk: The global rustflags `-Dmissing_docs` in `.cargo/config.toml`
  apply to all crates including benchmarks. Severity: medium. Likelihood: high.
  Mitigation: add `//!` crate-level doc comments and `///` doc comments to all
  public items in bench files. Benchmark functions generated by Criterion
  macros may need `#[allow]` attributes.

- Risk: Criterion benchmarks may be slow for larger dataset sizes,
  making `make bench` impractical for quick runs. Severity: low. Likelihood:
  medium. Mitigation: keep default dataset sizes moderate (100, 500, 1000).
  Larger sizes (5000) included only in the HNSW group where scaling behaviour
  is most informative. Criterion's `sample_size` and `measurement_time` can be
  tuned per group.

## Progress

- [x] Write execplan document.
- [x] Create `chutoro-benches/` directory structure and `Cargo.toml`.
- [x] Implement `SyntheticSource` in `src/source.rs` with unit tests.
- [x] Implement benchmark parameter structs in `src/params.rs`.
- [x] Wire up `src/lib.rs` as the crate root.
- [x] Write HNSW build benchmark in `benches/hnsw.rs`.
- [x] Write edge harvest benchmark in `benches/edge_harvest.rs`.
- [x] Write MST benchmark in `benches/mst.rs`.
- [x] Write hierarchy extraction benchmark in `benches/extraction.rs`.
- [x] Add `chutoro-benches` to workspace members in root `Cargo.toml`.
- [x] Add `bench` target to `Makefile`.
- [x] Run `make check-fmt`, `make lint`, `make test`.
- [x] Run `make bench` and verify Criterion output (via `make test`).
- [x] Mark roadmap §2.1.1 as done in `docs/roadmap.md`.

## Surprises & discoveries

- Observation: Criterion 0.5.1 macros generate code that violates
  workspace-level Clippy lints: `missing_docs`, `shadow_reuse`, and
  `excessive_nesting`. Evidence: Clippy errors on bench files without
  file-level lint suppression. Impact: Each bench file uses tightly scoped
  `#![expect(…)]` attributes with reasons. `.expect()` usage was eliminated via
  fallible `_impl` helpers returning `BenchSetupError`.

- Observation: The `float_arithmetic` `#[expect]` on `generate()` was
  unfulfilled after formatting because `rng.gen_range()` does not trigger the
  lint (the float arithmetic is inside the `rand` crate). Evidence:
  `unfulfilled-lint-expectations` error from Clippy. Impact: Removed the
  `#[expect]` from `generate()`, keeping it only on `distance()` where it is
  actually needed.

- Observation: `thiserror` was needed as a direct dependency for
  `SyntheticError` despite being a transitive dependency of `chutoro-core`.
  Evidence: Compilation error
  `failed to resolve: use of unresolved module or unlinked crate`. Impact:
  Added `thiserror = "1.0.69"` to `[dependencies]`. This was anticipated as a
  tolerance risk but did not require escalation since `thiserror` is already in
  the workspace dependency graph.

## Decision log

_Table 1: Decision log._

| Decision                                                                                                             | Rationale                                                                                                                                                                                                                                                     | Date/Author         |
| -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| Separate `chutoro-benches` crate (not `benches/` in `chutoro-core`)                                                  | Criterion benchmarks are separate binaries; a dedicated crate keeps benchmark support code testable and avoids polluting the core crate's dev-dependencies                                                                                                    | 2026-02-13 (Claude) |
| `SyntheticSource` lives in `chutoro-benches` (not `chutoro-test-support`)                                            | `chutoro-test-support` has no dependency on `chutoro-core`; adding one would create a circular test dependency. The synthetic source is benchmark-specific.                                                                                                   | 2026-02-13 (Claude) |
| Crate does NOT inherit workspace lints                                                                               | Criterion's generated code triggers many of the strict workspace denials (`unwrap_used`, `missing_docs` on generated items). A custom lint section allows compliance for handwritten code while accommodating the harness.                                    | 2026-02-13 (Claude) |
| Uniform random vectors (not Gaussian blobs) for initial benchmarks                                                   | Simpler to generate, reproducible with a seed, sufficient for timing baselines. Gaussian blobs are deferred to roadmap §2.1.2.                                                                                                                                | 2026-02-13 (Claude) |
| Dataset sizes {100, 500, 1000} for most benchmarks, {100, 500, 1000, 5000} for HNSW build                            | Keeps `make bench` completable in reasonable time while showing scaling behaviour for the dominant pipeline stage                                                                                                                                             | 2026-02-13 (Claude) |
| Edge harvest benchmarked as `build_with_edges` vs `build` differential, plus standalone `EdgeHarvest::from_unsorted` | The harvest step is integrated into build; timing it separately requires either instrumentation (invasive) or differential measurement (non-invasive). Standalone `EdgeHarvest::from_unsorted` benchmarks the sorting/dedup cost.                             | 2026-02-13 (Claude) |
| Added `thiserror` as direct dependency for `SyntheticError` and `BenchSetupError`                                    | Transitive availability is not guaranteed by Cargo; the derive macro requires the crate in scope. Already in the workspace dependency graph so no new external code is pulled in.                                                                             | 2026-02-13 (Claude) |
| File-level `#![expect]` on bench files for Criterion-triggered lints                                                 | Criterion's `bench_with_input` + `b.iter` pattern inherently triggers `missing_docs`, `shadow_reuse`, and `excessive_nesting`. File-level `#![expect(…)]` with reasons is the narrowest practical scope since every bench function exhibits these patterns.   | 2026-02-15 (Claude) |
| Fallible benchmark setup helpers with `BenchSetupError`                                                              | Eliminates `.expect()` outside tests by propagating errors with `?` in `_impl` functions. The thin `criterion_group!` wrappers panic on setup failure only at the entrypoint.                                                                                 | 2026-02-15 (Claude) |
| Edge harvest input shuffled before benchmarking                                                                      | `build_with_edges` returns pre-sorted edges; benchmarking `from_unsorted` on sorted data would under-report the sorting cost. A seeded shuffle produces a realistic unsorted distribution.                                                                    | 2026-02-15 (Claude) |
| `iter_batched` for clone-heavy benchmarks                                                                            | Moves `Vec::clone()` (edge harvest) and `HnswParams::clone()` (HNSW build) out of the measured path so that benchmarks reflect only the target operation's cost.                                                                                              | 2026-02-15 (Claude) |

## Outcomes & retrospective

Completed all four benchmark groups plus the `SyntheticSource` library code
with 15 unit tests. All 639 tests pass (including the 15 new `chutoro-benches`
unit tests and benchmark harness test runs for all parameter combinations). All
quality gates (`make check-fmt`, `make lint`, `make test`) pass. Roadmap entry
§2.1.1 marked as done.

The main challenge was accommodating the workspace's strict Clippy lint
configuration with Criterion's macro-generated code. The solution — a
crate-local `[lints]` section mirroring workspace strictness plus tightly
scoped `#![expect(…)]` attributes on bench files — proved effective and keeps
the handwritten library code under full lint scrutiny. PR review feedback
prompted additional improvements: fallible benchmark setup helpers
(`BenchSetupError`) eliminating `.expect()` outside tests, `iter_batched` to
exclude clone overhead from measurements, shuffled edge-harvest input to avoid
benchmarking pre-sorted data, and narrowed lint suppression scopes throughout.

Files created: 9 new files in `chutoro-benches/` (4 library, 4 benchmark, 1
manifest). Files modified: 3 (root `Cargo.toml`, `Makefile`, `docs/roadmap.md`).

## Context and orientation

### Repository structure

The chutoro repository is a Rust workspace (resolver "3", edition 2024, MSRV
1.88.0) containing five crates:

_Table 2: Workspace crates._

| Crate                     | Path                       | Purpose                                      |
| ------------------------- | -------------------------- | -------------------------------------------- |
| `chutoro-core`            | `chutoro-core/`            | Core library: HNSW, MST, hierarchy, distance |
| `chutoro-cli`             | `chutoro-cli/`             | CLI binary                                   |
| `chutoro-providers-dense` | `chutoro-providers/dense/` | Parquet/Arrow data provider                  |
| `chutoro-providers-text`  | `chutoro-providers/text/`  | Text/Levenshtein data provider               |
| `chutoro-test-support`    | `chutoro-test-support/`    | CI utilities, property test profiling        |

No benchmark infrastructure exists. There are no `benches/` directories, no
Criterion dependency, and no `[[bench]]` sections in any `Cargo.toml`.

### Pipeline stages to benchmark

The CPU Flexible, Incremental, Scalable, Hierarchical Density-Based Clustering
(FISHDBC) pipeline (`chutoro-core/src/cpu_pipeline.rs`) runs four stages
sequentially:

1. **HNSW build** — `CpuHnsw::build(source, params)` constructs an
   approximate nearest-neighbour index. The variant
   `CpuHnsw::build_with_edges(source, params)` additionally harvests candidate
   edges for MST construction. File: `chutoro-core/src/hnsw/cpu/mod.rs`.

2. **Edge harvest** — candidate edges are collected during HNSW
   insertion via `EdgeHarvest::from_parallel_inserts`. The public constructor
   `EdgeHarvest::new(edges)` sorts and deduplicates. File:
   `chutoro-core/src/hnsw/types.rs`.

3. **MST** — `parallel_kruskal(node_count, &EdgeHarvest)` computes a
   minimum spanning forest using parallel sort and striped-lock union-find.
   File: `chutoro-core/src/mst/mod.rs`.

4. **Hierarchy extraction** —
   `extract_labels_from_mst(node_count, edges, config)` derives flat cluster
   labels from the MST via single-linkage condensation and excess-of-mass
   scoring. File: `chutoro-core/src/hierarchy/mod.rs`.

### Key types

- `DataSource` trait (`chutoro-core/src/datasource.rs`): requires
  `len()`, `name()`, `distance(i, j) -> Result<f32, DataSourceError>`.
- `HnswParams` (`chutoro-core/src/hnsw/params.rs`): builder with
  `new(max_connections, ef_construction)`, `.with_rng_seed(u64)`.
- `HierarchyConfig` (`chutoro-core/src/hierarchy/mod.rs`):
  `new(min_cluster_size: NonZeroUsize)`.
- `CandidateEdge` (`chutoro-core/src/hnsw/types.rs`):
  `new(source, target, distance, sequence)`.
- `EdgeHarvest` (`chutoro-core/src/hnsw/types.rs`):
  `new(Vec<CandidateEdge>)`, `from_unsorted(Vec<CandidateEdge>)`.
- `MstEdge`, `MinimumSpanningForest`
  (`chutoro-core/src/mst/mod.rs`).

### Existing test patterns

Tests use `rstest` (0.23) for fixtures and parameterized cases, `proptest`
(1.8) for property testing. The `#[fixture]` and `#[case::name]` patterns are
used extensively. The existing `DummySource` fixtures are all `pub(super)` and
`#[cfg(test)]`, so they cannot be reused from an external crate.

## Plan of work

### Stage A: Crate scaffolding

Create the `chutoro-benches/` directory and `Cargo.toml`. Add the crate as a
workspace member. The crate is a library (for testable support code) with four
`[[bench]]` entries.

### Stage B: SyntheticSource and benchmark parameters

Implement `SyntheticSource` as a `DataSource` over pre-generated N-dimensional
f32 vectors with Euclidean distance. Add parameter structs to keep benchmark
function signatures tidy. Write unit tests covering happy paths, error cases,
and distance properties.

### Stage C: Benchmark implementations

Four benchmark files in `chutoro-benches/benches/`, each under 400 lines. All
use Criterion's `criterion_group!` and `criterion_main!` macros.

### Stage D: Makefile, roadmap, and quality gates

Add `bench` target to Makefile. Mark roadmap §2.1.1 as done. Run all quality
gates and benchmarks.

## Validation and acceptance

- Tests: `make test` passes including new `chutoro-benches` unit tests.
- Lint: `make check-fmt` and `make lint` pass with zero warnings.
- Benchmarks: `make bench` completes with Criterion timing output.
- Roadmap: item 2.1.1 is marked `[x]` in `docs/roadmap.md`.

## Idempotence and recovery

All steps are safe to rerun. The `chutoro-benches` crate is purely additive. If
any step fails, fix the issue and rerun the failing command.

## References

- `docs/roadmap.md` §2.1.1 (tracking)
- `docs/chutoro-design.md` §11 (concluding recommendations)
- `chutoro-core/src/cpu_pipeline.rs` (pipeline orchestration)
- `chutoro-core/src/hnsw/cpu/mod.rs` (HNSW build API)
- `chutoro-core/src/hnsw/types.rs` (EdgeHarvest, CandidateEdge)
- `chutoro-core/src/mst/mod.rs` (parallel_kruskal)
- `chutoro-core/src/hierarchy/mod.rs` (extract_labels_from_mst)
- `AGENTS.md` (quality gates and coding standards)
